<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon projet Tailwind</title>
  <link href="src/output.css" rel="stylesheet" />
</head>

<body class="bg-gray-100 text-gray-900 font-sans min-h-screen flex flex-col">
  <!-- Navbar -->
  <header class="bg-orange-200 shadow">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="text-xl font-bold text-amber-800">Mon projet GBA</a>

      <nav class="space-x-4 hidden md:block">
        <a href="index.html" class="text-gray-700 hover:text-gray-600">Accueil</a>
        <a href="pokedex.html" class="text-gray-700 hover:text-gray-600">Pokedex</a>
        <a href="contact.html" class="text-gray-700 hover:text-gray-600">Contact</a>
        <a href="apiPokemon.html" class="text-gray-700 hover:text-gray-600">API Pokémon</a>
      </nav>

      <button id="menu-toggle" class="md:hidden text-gray-700 focus:outline-none" aria-label="Toggle menu">
        ☰
      </button>
    </div>

    <!-- Menu mobile -->
    <div id="mobile-menu" class="md:hidden hidden px-4 pb-4 space-y-2">
      <a href="index.html" class="block text-gray-700 hover:text-gray-600">Accueil</a>
      <a href="pokedex.html" class="block text-gray-700 hover:text-gray-600">Pokedex</a>
      <a href="contact.html" class="block text-gray-700 hover:text-gray-600">Contact</a>
      <a href="apiPokemon.html" class="block text-gray-700 hover:text-gray-600">API Pokémon</a>
    </div>
  </header>
  <div class="max-w-6xl mx-auto p-4 grid grid-cols-1 md:grid-cols-3 gap-8">
    <!-- Partie principale : émulateur -->
    <div class="col-span-2">
      <h1 class="text-3xl font-bold text-center mb-6 text-red-600">Émulateur Pokémon Rouge Feu</h1>

      <div id="canvas-wrapper" class="relative mx-auto w-full max-w-[480px] h-auto" style="aspect-ratio: 3 / 2;">
        <img id="rom-image" src="public/emulator/rom/pokemonRubis.jpg" alt="Pokémon Rubis"
          class="absolute inset-0 w-full h-full object-contain block" />
        <canvas id="gba-screen" width="480" height="320"
          class="absolute inset-0 border border-gray-500 rounded-lg hidden"
          style="image-rendering: pixelated; image-rendering: crisp-edges;"></canvas>
      </div>

      <!-- Boutons tactiles - version Tailwind, intégrée -->
      <div id="touch-controls"
        class="grid grid-cols-5 gap-4 p-6 bg-gray-900 rounded-xl text-white max-w-md mx-auto my-8 shadow-lg">
        <!-- Bouton L -->
        <button data-key="L"
          class="col-span-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">L</button>

        <!-- Espace vide centré -->
        <div class="col-span-3"></div>

        <!-- Bouton R -->
        <button data-key="R"
          class="col-span-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">R</button>

        <!-- Croix directionnelle -->
        <div class="col-span-2 flex flex-col items-center justify-center">
          <button data-key="UP" class="w-10 h-10 mb-2 bg-red-600 hover:bg-red-700 rounded-full shadow-md">↑</button>
          <div class="flex space-x-2">
            <button data-key="LEFT" class="w-10 h-10 bg-red-600 hover:bg-red-700 rounded-full shadow-md">←</button>
            <div class="w-10 h-10"></div>
            <button data-key="RIGHT" class="w-10 h-10 bg-red-600 hover:bg-red-700 rounded-full shadow-md">→</button>
          </div>
          <button data-key="DOWN" class="w-10 h-10 mt-2 bg-red-600 hover:bg-red-700 rounded-full shadow-md">↓</button>
        </div>

        <!-- Espace vide -->
        <div></div>

        <!-- Boutons A et B -->
        <div class="col-span-2 flex flex-col items-center justify-center space-y-2">
          <button data-key="A" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 text-lg rounded-full shadow-md">A</button>
          <button data-key="B" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 text-lg rounded-full shadow-md">B</button>
        </div>

        <!-- Boutons Start et Select -->
        <div class="col-span-5 flex justify-center gap-4 mt-4">
          <button data-key="START" class="bg-green-600 hover:bg-green-700 py-2 px-6 rounded-lg shadow-md">Start</button>
          <button data-key="SELECT"
            class="bg-green-600 hover:bg-green-700 py-2 px-6 rounded-lg shadow-md">Select</button>
        </div>
      </div>

      <div class="text-center mt-4">
        <button id="reset-positions"
          class="bg-gray-800 hover:bg-black text-white py-2 px-4 rounded shadow">Réinitialiser les positions</button>
      </div>

      <div class="mt-4 text-center">
        <button id="startBtn"
          class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow">Lancer
          l’émulateur</button>
      </div>

      <div class="mt-2 text-center">
        <label for="zoomSelect" class="mr-2 font-semibold text-gray-700">Zoom :</label>
        <select id="zoomSelect" class="border rounded p-1 shadow">
          <option value="1">x1</option>
          <option value="2" selected>x2</option>
          <option value="3">x3</option>
          <option value="4">x4</option>
        </select>
      </div>
    </div>

    <!-- Partie droite : commandes -->
    <div class="bg-gray-100 p-4 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold text-center mb-4">Commandes</h2>
      <ul class="space-y-2 text-gray-700 text-sm md:text-base">
        <li><strong>↑ ↓ ← →</strong> : Déplacements</li>
        <li><strong>Z</strong> : A (valider)</li>
        <li><strong>X</strong> : B (annuler)</li>
        <li><strong>Entrée</strong> : Start</li>
        <li><strong>Shift</strong> : Select</li>
        <li><strong>A</strong> : L</li>
        <li><strong>S</strong> : R</li>
      </ul>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-white shadow p-4 text-center text-sm text-gray-600">
    &copy; 2025 - Mon projet GBA
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>


  <!-- JS général -->
  <script>
    // Menu mobile toggle
    document.getElementById('menu-toggle').addEventListener('click', () => {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('hidden');
    });
  </script>

  <!-- Scripts émulateur -->
  <script src="public/emulator/gbajs/js/gba.js"></script>
  <script src="public/emulator/gbajs/js/arm.js"></script>
  <script src="public/emulator/gbajs/js/audio.js"></script>
  <script src="public/emulator/gbajs/js/core.js"></script>
  <script src="public/emulator/gbajs/js/gpio.js"></script>
  <script src="public/emulator/gbajs/js/io.js"></script>
  <script src="public/emulator/gbajs/js/irq.js"></script>
  <script src="public/emulator/gbajs/js/keypad.js"></script>
  <script src="public/emulator/gbajs/js/mmu.js"></script>
  <script src="public/emulator/gbajs/js/savedata.js"></script>
  <script src="public/emulator/gbajs/js/sio.js"></script>
  <script src="public/emulator/gbajs/js/thumb.js"></script>
  <script src="public/emulator/gbajs/js/video.js"></script>
  <script src="public/emulator/gbajs/js/util.js"></script>
  <script src="public/emulator/gbajs/js/video/proxy.js"></script>
  <script src="public/emulator/gbajs/js/video/software.js"></script>
  <script src="public/emulator/gbajs/resources/xhr.js"></script>
  <script src="public/emulator/gbajs/resources/console.js"></script>

  <script>
    const canvas = document.getElementById('gba-screen');
    const startBtn = document.getElementById('startBtn');
    const zoomSelect = document.getElementById('zoomSelect');
    const romImage = document.getElementById('rom-image');
    let gba = null;

    const baseWidth = 240;
    const baseHeight = 160;

    function applyZoom(factor) {
      const containerWidth = document.getElementById('canvas-wrapper').clientWidth;
      let newWidth = baseWidth * factor;
      let newHeight = baseHeight * factor;

      if (newWidth > containerWidth) {
        const scaleDownFactor = containerWidth / newWidth;
        newWidth = containerWidth;
        newHeight = baseHeight * factor * scaleDownFactor;
      }

      canvas.width = newWidth;
      canvas.height = newHeight;
      canvas.style.width = `${newWidth}px`;
      canvas.style.height = `${newHeight}px`;

      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      canvas.style.imageRendering = "pixelated";
      canvas.style.imageRendering = "crisp-edges";
    }

    applyZoom(parseInt(zoomSelect.value));
    zoomSelect.addEventListener('change', () => applyZoom(parseInt(zoomSelect.value)));

    async function loadBinary(path) {
      const response = await fetch(path);
      if (!response.ok) throw new Error(`Erreur : ${response.statusText}`);
      return await response.arrayBuffer();
    }

    startBtn.addEventListener('click', async () => {
      if (gba) return;

      try {
        gba = new GameBoyAdvance();
        gba.setLogger((level, message) => console.log('GBA log:', level, message));
        gba.setCanvas(canvas);

        startBtn.disabled = true;
        startBtn.textContent = 'Chargement en cours...';

        const biosBuffer = await loadBinary('public/emulator/rom/bios.bin');
        const romBuffer = await loadBinary('public/emulator/rom/PokemonRubis.gba');

        gba.setBios(biosBuffer, true);
        gba.setRom(romBuffer);
        gba.runStable();

        romImage.style.display = 'none';
        canvas.classList.remove('hidden');
        startBtn.textContent = 'Émulateur lancé';
      } catch (e) {
        console.error(e);
        alert('Erreur : ' + e.message);
        gba = null;
        startBtn.textContent = 'Lancer l’émulateur';
        startBtn.disabled = false;
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      const keypad = new GameBoyAdvanceKeypad();
      keypad.init();
    });

    GameBoyAdvanceKeypad.prototype.touchHandler = function (e) {
      console.log('touchHandler event:', e.type, e.target.getAttribute('data-key'));
      const keyName = e.target.getAttribute('data-key');
      if (!keyName) return;

      const keyMap = {
        'LEFT': this.LEFT,
        'UP': this.UP,
        'RIGHT': this.RIGHT,
        'DOWN': this.DOWN,
        'START': this.START,
        'SELECT': this.SELECT,
        'A': this.A,
        'B': this.B,
        'L': this.L,
        'R': this.R,
      };

      const toggle = keyMap[keyName];
      if (toggle === undefined) return;

      let bit = 1 << toggle;
      let isDown = (e.type === 'touchstart' || e.type === 'mousedown');

      if (isDown) {
        this.currentDown &= ~bit;
      } else {
        this.currentDown |= bit;
      }

      e.preventDefault();
    };

    // Supposons que keypad est ton instance de GameBoyAdvanceKeypad
    // par exemple : const keypad = new GameBoyAdvanceKeypad();

    document.getElementById('touch-controls').addEventListener('touchstart', function (e) {
      if (e.target.tagName === 'BUTTON') {
        const key = e.target.getAttribute('data-key');
        if (key && keypad[key] !== undefined) {
          // Simuler keydown sur la touche correspondante
          const bit = 1 << keypad[key];
          keypad.currentDown &= ~bit;
          e.preventDefault();
        }
      }
    }, { passive: false });

    document.getElementById('touch-controls').addEventListener('touchend', function (e) {
      if (e.target.tagName === 'BUTTON') {
        const key = e.target.getAttribute('data-key');
        if (key && keypad[key] !== undefined) {
          // Simuler keyup sur la touche correspondante
          const bit = 1 << keypad[key];
          keypad.currentDown |= bit;
          e.preventDefault();
        }
      }
    }, { passive: false });



  </script>

  <script>
    // Attendre que GBA soit démarré
    function triggerKey(key, type = 'keydown') {
      if (!gba || !gba.keypad) return;

      const keyMap = {
        'UP': 38,
        'DOWN': 40,
        'LEFT': 37,
        'RIGHT': 39,
        'A': 90,       // Z
        'B': 88,       // X
        'L': 65,       // A
        'R': 83,       // S
        'START': 13,   // Entrée
        'SELECT': 16   // Shift
      };

      const keyCode = keyMap[key];
      if (!keyCode) return;

      const method = type === 'keydown' ? 'keydown' : 'keyup';
      const event = new KeyboardEvent(method, { keyCode: keyCode, which: keyCode, bubbles: true });
      document.dispatchEvent(event);
    }

    document.querySelectorAll('#touch-controls button').forEach(button => {
      const key = button.getAttribute('data-key');

      // Pour tactile et souris : mousedown/touchstart = keydown, mouseup/touchend = keyup
      button.addEventListener('touchstart', e => {
        e.preventDefault(); // évite le double-clic ou scroll
        triggerKey(key, 'keydown');
      });

      button.addEventListener('touchend', e => {
        e.preventDefault();
        triggerKey(key, 'keyup');
      });

      button.addEventListener('mousedown', () => triggerKey(key, 'keydown'));
      button.addEventListener('mouseup', () => triggerKey(key, 'keyup'));
      button.addEventListener('mouseleave', () => triggerKey(key, 'keyup'));
    });
  </script>


</body>

</html>